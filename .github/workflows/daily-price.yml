name: Metal Prices Automation

on:
  schedule:
    - cron: '*/5 * * * *'    # Every 5 minutes â†’ Gold & Silver alerts
    - cron: '30 18 * * *'    # 12:00 AM IST â†’ Daily save
    - cron: '30 3 * * *'     # 9:00 AM IST â†’ Daily summary
    - cron: '30 3 * * 0'     # Weekly summary (Sunday 9 AM IST)
    - cron: '30 3 1 * *'     # Monthly summary (1st day, 9 AM IST)
  workflow_dispatch:

jobs:
  metals:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq & bc
        run: sudo apt-get update && sudo apt-get install jq bc -y

      - name: Fetch prices, alert & save
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          DATE=$(date -u +"%Y-%m-%d")
          HOUR=$(date -u +"%H")
          DAY=$(date -u +"%w")       # 0 = Sunday
          DAY_OF_MONTH=$(date -u +"%d")
          FILE=data/daily_prices.json

          # Fetch prices (1g base)
          GOLD=$(curl -s https://api.gold-api.com/price/XAU | jq .price)
          SILVER=$(curl -s https://api.gold-api.com/price/XAG | jq .price)
          PLATINUM=$(curl -s https://api.gold-api.com/price/XPT | jq .price)
          PALLADIUM=$(curl -s https://api.gold-api.com/price/XPD | jq .price)
          COPPER=$(curl -s https://api.gold-api.com/price/HG | jq .price)

          # Read previous saved prices
          GOLD_OLD=$(jq -r ".\"$DATE\".gold // empty" $FILE)
          SILVER_OLD=$(jq -r ".\"$DATE\".silver // empty" $FILE)

          # ðŸ”” Gold alert (every 5 minutes)
          if [ "$GOLD_OLD" != "" ]; then
            DIFF=$(echo "$GOLD - $GOLD_OLD" | bc)
            if (( $(echo "$DIFF != 0" | bc -l) )); then
              curl -s -X POST https://api.telegram.org/bot$BOT_TOKEN/sendMessage \
                -d chat_id=$CHAT_ID \
                -d text="ðŸš¨ Gold (1g) Update\nPrevious: â‚¹$GOLD_OLD\nCurrent: â‚¹$GOLD"
            fi
          fi

          # ðŸ”” Silver alert (every 5 minutes)
          if [ "$SILVER_OLD" != "" ]; then
            DIFF=$(echo "$SILVER - $SILVER_OLD" | bc)
            if (( $(echo "$DIFF != 0" | bc -l) )); then
              curl -s -X POST https://api.telegram.org/bot$BOT_TOKEN/sendMessage \
                -d chat_id=$CHAT_ID \
                -d text="ðŸš¨ Silver (1g) Update\nPrevious: â‚¹$SILVER_OLD\nCurrent: â‚¹$SILVER"
            fi
          fi

          # ðŸ“© Daily summary at 9 AM IST
          if [ "$HOUR" = "03" ]; then
            curl -s -X POST https://api.telegram.org/bot$BOT_TOKEN/sendMessage \
              -d chat_id=$CHAT_ID \
              -d text="ðŸ“Š Daily Metal Prices (1g)\n\nGold: â‚¹$GOLD\nSilver: â‚¹$SILVER\nPlatinum: â‚¹$PLATINUM\nPalladium: â‚¹$PALLADIUM\nCopper: â‚¹$COPPER"
          fi

          # ðŸ“ˆ Weekly summary + Worst/Best day (Sunday only)
          if [ "$DAY" = "0" ] && [ "$HOUR" = "03" ]; then
            END_DATE=$(date -u +"%Y-%m-%d")
            START_DATE=$(date -u -d "7 days ago" +"%Y-%m-%d")

            GOLD_START=$(jq -r ".\"$START_DATE\".gold // empty" $FILE)
            GOLD_END=$(jq -r ".\"$END_DATE\".gold // empty" $FILE)
            SILVER_START=$(jq -r ".\"$START_DATE\".silver // empty" $FILE)
            SILVER_END=$(jq -r ".\"$END_DATE\".silver // empty" $FILE)

            GOLD_DIFF=$(echo "$GOLD_END - $GOLD_START" | bc)
            SILVER_DIFF=$(echo "$SILVER_END - $SILVER_START" | bc)

            GOLD_PCT=$(echo "scale=2; ($GOLD_DIFF / $GOLD_START) * 100" | bc)
            SILVER_PCT=$(echo "scale=2; ($SILVER_DIFF / $SILVER_START) * 100" | bc)

            WORST_DAY=""
            BEST_DAY=""

            for i in {1..7}; do
              D1=$(date -u -d "$i days ago" +"%Y-%m-%d")
              D2=$(date -u -d "$((i-1)) days ago" +"%Y-%m-%d")

              G1=$(jq -r ".\"$D1\".gold // empty" $FILE)
              G2=$(jq -r ".\"$D2\".gold // empty" $FILE)
              S1=$(jq -r ".\"$D1\".silver // empty" $FILE)
              S2=$(jq -r ".\"$D2\".silver // empty" $FILE)

              if [ "$G1" != "" ] && [ "$G2" != "" ]; then
                GD=$(echo "$G2 - $G1" | bc)
                if (( $(echo "${GD#-} > 1000" | bc -l) )); then
                  WORST_DAY="$D2 (Gold â‚¹$GD)"
                fi
                if (( $(echo "$GD < 0" | bc -l) )); then
                  BEST_DAY="$D2 (Gold drop â‚¹$GD)"
                fi
              fi

              if [ "$S1" != "" ] && [ "$S2" != "" ]; then
                SD=$(echo "$S2 - $S1" | bc)
                if (( $(echo "${SD#-} > 20" | bc -l) )); then
                  WORST_DAY="$D2 (Silver â‚¹$SD)"
                fi
                if (( $(echo "$SD < 0" | bc -l) )); then
                  BEST_DAY="$D2 (Silver drop â‚¹$SD)"
                fi
              fi
            done

            curl -s -X POST https://api.telegram.org/bot$BOT_TOKEN/sendMessage \
              -d chat_id=$CHAT_ID \
              -d text="ðŸ“ˆ Weekly Summary (1g)\nFrom: $(date -d $START_DATE +%d/%m/%Y) â†’ $(date -d $END_DATE +%d/%m/%Y)\n\nGold: â‚¹$GOLD_DIFF ($GOLD_PCT%)\nSilver: â‚¹$SILVER_DIFF ($SILVER_PCT%)\n\nâŒ Worst Day: ${WORST_DAY:-None}\nâœ… Best Day: ${BEST_DAY:-None}"
          fi

          # ðŸ“… Monthly summary (1st day only)
          if [ "$DAY_OF_MONTH" = "01" ] && [ "$HOUR" = "03" ]; then
            END_DATE=$(date -u -d "yesterday" +"%Y-%m-%d")
            START_DATE=$(date -u -d "$(date -u +%Y-%m-01)" +"%Y-%m-%d")

            GOLD_START=$(jq -r ".\"$START_DATE\".gold // empty" $FILE)
            GOLD_END=$(jq -r ".\"$END_DATE\".gold // empty" $FILE)
            SILVER_START=$(jq -r ".\"$START_DATE\".silver // empty" $FILE)
            SILVER_END=$(jq -r ".\"$END_DATE\".silver // empty" $FILE)

            GOLD_DIFF=$(echo "$GOLD_END - $GOLD_START" | bc)
            GOLD_PCT=$(echo "scale=2; ($GOLD_DIFF / $GOLD_START) * 100" | bc)
            SILVER_DIFF=$(echo "$SILVER_END - $SILVER_START" | bc)
            SILVER_PCT=$(echo "scale=2; ($SILVER_DIFF / $SILVER_START) * 100" | bc)

            curl -s -X POST https://api.telegram.org/bot$BOT_TOKEN/sendMessage \
              -d chat_id=$CHAT_ID \
              -d text="ðŸ“… Monthly Summary (1g)\nFrom: $(date -d $START_DATE +%d/%m/%Y) â†’ $(date -d $END_DATE +%d/%m/%Y)\n\nGold: â‚¹$GOLD_DIFF ($GOLD_PCT%)\nSilver: â‚¹$SILVER_DIFF ($SILVER_PCT%)"
          fi

          # ðŸ’¾ Daily save (source of truth)
          jq ".\"$DATE\" = {
            \"gold\": $GOLD,
            \"silver\": $SILVER,
            \"platinum\": $PLATINUM,
            \"palladium\": $PALLADIUM,
            \"copper\": $COPPER
          }" $FILE > temp.json

          mv temp.json $FILE

      - name: Commit & push
        run: |
          git config user.name github-actions
          git config user.email actions@github.com
          git add data/daily_prices.json
          git diff --cached --quiet || git commit -m "Metal prices update"
          git push
