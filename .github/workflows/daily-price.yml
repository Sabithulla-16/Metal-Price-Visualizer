name: Metal Prices Automation

on:
  schedule:
    - cron: '*/5 * * * *'
    - cron: '30 18 * * *'
    - cron: '30 3 * * *'
    - cron: '30 3 * * 0'
    - cron: '30 3 1 * *'
  workflow_dispatch:

jobs:
  metals:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq & bc
        run: sudo apt-get update && sudo apt-get install jq bc -y

      - name: Fetch prices, alert & save
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          DATE=$(date -u +"%Y-%m-%d")
          HOUR=$(date -u +"%H")
          DAY=$(date -u +"%w")
          DAY_OF_MONTH=$(date -u +"%d")
          FILE=data/daily_prices.json

          OZ=31.1035
          DUTY=1.06
          GST=1.03

          INR=$(curl -s "https://api.frankfurter.app/latest?from=USD&to=INR" | jq .rates.INR)

          GOLD_USD=$(curl -s https://api.gold-api.com/price/XAU | jq .price)
          SILVER_USD=$(curl -s https://api.gold-api.com/price/XAG | jq .price)
          PLATINUM_USD=$(curl -s https://api.gold-api.com/price/XPT | jq .price)
          PALLADIUM_USD=$(curl -s https://api.gold-api.com/price/XPD | jq .price)
          COPPER_USD=$(curl -s https://api.gold-api.com/price/HG | jq .price)

          GOLD=$(echo "scale=2; ($GOLD_USD/$OZ)*$INR*$DUTY*$GST" | bc)
          SILVER=$(echo "scale=2; ($SILVER_USD/$OZ)*$INR*$DUTY*$GST" | bc)
          PLATINUM=$(echo "scale=2; ($PLATINUM_USD/$OZ)*$INR*$DUTY*$GST" | bc)
          PALLADIUM=$(echo "scale=2; ($PALLADIUM_USD/$OZ)*$INR*$DUTY*$GST" | bc)
          COPPER=$(echo "scale=2; ($COPPER_USD/$OZ)*$INR*$DUTY*$GST" | bc)

          GOLD_OLD=$(jq -r ".\"$DATE\".gold // empty" "$FILE")
          SILVER_OLD=$(jq -r ".\"$DATE\".silver // empty" "$FILE")

          if [ "$GOLD_OLD" != "" ]; then
            DIFF=$(echo "$GOLD - $GOLD_OLD" | bc)
            if (( $(echo "$DIFF != 0" | bc -l) )); then
              if (( $(echo "$DIFF > 0" | bc -l) )); then ARROW="ðŸ”º"; else ARROW="ðŸ”»"; fi
              MESSAGE="$ARROW Gold (1g) Update"
              MESSAGE="$MESSAGE"$'\n'"Previous: â‚¹$GOLD_OLD"
              MESSAGE="$MESSAGE"$'\n'"Current: â‚¹$GOLD"
              curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
                -d chat_id="$CHAT_ID" \
                --data-urlencode text="$MESSAGE"
            fi
          fi

          if [ "$SILVER_OLD" != "" ]; then
            DIFF=$(echo "$SILVER - $SILVER_OLD" | bc)
            if (( $(echo "$DIFF != 0" | bc -l) )); then
              if (( $(echo "$DIFF > 0" | bc -l) )); then ARROW="ðŸ”º"; else ARROW="ðŸ”»"; fi
              MESSAGE="$ARROW Silver (1g) Update"
              MESSAGE="$MESSAGE"$'\n'"Previous: â‚¹$SILVER_OLD"
              MESSAGE="$MESSAGE"$'\n'"Current: â‚¹$SILVER"
              curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
                -d chat_id="$CHAT_ID" \
                --data-urlencode text="$MESSAGE"
            fi
          fi

          if [ "$HOUR" = "03" ]; then
            MESSAGE="ðŸ“Š Daily Metal Prices (1g)"
            MESSAGE="$MESSAGE"$'\n\n'"Gold: â‚¹$GOLD"
            MESSAGE="$MESSAGE"$'\n'"Silver: â‚¹$SILVER"
            MESSAGE="$MESSAGE"$'\n'"Platinum: â‚¹$PLATINUM"
            MESSAGE="$MESSAGE"$'\n'"Palladium: â‚¹$PALLADIUM"
            MESSAGE="$MESSAGE"$'\n'"Copper: â‚¹$COPPER"
            curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
              -d chat_id="$CHAT_ID" \
              --data-urlencode text="$MESSAGE"
          fi

          if [ "$DAY" = "0" ] && [ "$HOUR" = "03" ]; then
            END_DATE=$(date -u +"%Y-%m-%d")
            START_DATE=$(date -u -d "7 days ago" +"%Y-%m-%d")

            GOLD_START=$(jq -r ".\"$START_DATE\".gold // empty" "$FILE")
            GOLD_END=$(jq -r ".\"$END_DATE\".gold // empty" "$FILE")
            SILVER_START=$(jq -r ".\"$START_DATE\".silver // empty" "$FILE")
            SILVER_END=$(jq -r ".\"$END_DATE\".silver // empty" "$FILE")

            GOLD_DIFF=$(echo "$GOLD_END - $GOLD_START" | bc)
            SILVER_DIFF=$(echo "$SILVER_END - $SILVER_START" | bc)

            GOLD_PCT=$(echo "scale=2; ($GOLD_DIFF / $GOLD_START) * 100" | bc)
            SILVER_PCT=$(echo "scale=2; ($SILVER_DIFF / $SILVER_START) * 100" | bc)

            MESSAGE="ðŸ“ˆ Weekly Summary (1g)"
            MESSAGE="$MESSAGE"$'\n'"From: $(date -d "$START_DATE" +%d/%m/%Y) â†’ $(date -d "$END_DATE" +%d/%m/%Y)"
            MESSAGE="$MESSAGE"$'\n\n'"Gold: â‚¹$GOLD_DIFF ($GOLD_PCT%)"
            MESSAGE="$MESSAGE"$'\n'"Silver: â‚¹$SILVER_DIFF ($SILVER_PCT%)"

            curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
              -d chat_id="$CHAT_ID" \
              --data-urlencode text="$MESSAGE"
          fi

          if [ "$DAY_OF_MONTH" = "01" ] && [ "$HOUR" = "03" ]; then
            END_DATE=$(date -u -d "yesterday" +"%Y-%m-%d")
            START_DATE=$(date -u -d "$(date -u +%Y-%m-01)" +"%Y-%m-%d")

            GOLD_START=$(jq -r ".\"$START_DATE\".gold // empty" "$FILE")
            GOLD_END=$(jq -r ".\"$END_DATE\".gold // empty" "$FILE")
            SILVER_START=$(jq -r ".\"$START_DATE\".silver // empty" "$FILE")
            SILVER_END=$(jq -r ".\"$END_DATE\".silver // empty" "$FILE")

            GOLD_DIFF=$(echo "$GOLD_END - $GOLD_START" | bc)
            SILVER_DIFF=$(echo "$SILVER_END - $SILVER_START" | bc)

            GOLD_PCT=$(echo "scale=2; ($GOLD_DIFF / $GOLD_START) * 100" | bc)
            SILVER_PCT=$(echo "scale=2; ($SILVER_DIFF / $SILVER_START) * 100" | bc)

            MESSAGE="ðŸ“… Monthly Summary (1g)"
            MESSAGE="$MESSAGE"$'\n'"From: $(date -d "$START_DATE" +%d/%m/%Y) â†’ $(date -d "$END_DATE" +%d/%m/%Y)"
            MESSAGE="$MESSAGE"$'\n\n'"Gold: â‚¹$GOLD_DIFF ($GOLD_PCT%)"
            MESSAGE="$MESSAGE"$'\n'"Silver: â‚¹$SILVER_DIFF ($SILVER_PCT%)"

            curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
              -d chat_id="$CHAT_ID" \
              --data-urlencode text="$MESSAGE"
          fi

          jq ".\"$DATE\" = {
            \"gold\": $GOLD,
            \"silver\": $SILVER,
            \"platinum\": $PLATINUM,
            \"palladium\": $PALLADIUM,
            \"copper\": $COPPER
          }" "$FILE" > temp.json

          mv temp.json "$FILE"

      - name: Commit & push
        run: |
          git config user.name github-actions
          git config user.email actions@github.com
          git add data/daily_prices.json
          git diff --cached --quiet || git commit -m "Metal prices update"
          git push
