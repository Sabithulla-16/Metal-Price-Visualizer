name: Metal Prices Automation

on:
  schedule:
    - cron: '*/5 * * * *'    # Every 5 minutes â†’ Gold & Silver alerts
    - cron: '30 18 * * *'    # 12:00 AM IST â†’ Daily save
    - cron: '30 3 * * *'     # 9:00 AM IST â†’ Daily summary
  workflow_dispatch:

jobs:
  metals:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq & bc
        run: sudo apt-get update && sudo apt-get install jq bc -y

      - name: Fetch prices, alert & save
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          DATE=$(date -u +"%Y-%m-%d")
          HOUR=$(date -u +"%H")
          FILE=data/daily_prices.json

          # Fetch prices (1g base)
          GOLD=$(curl -s https://api.gold-api.com/price/XAU | jq .price)
          SILVER=$(curl -s https://api.gold-api.com/price/XAG | jq .price)
          PLATINUM=$(curl -s https://api.gold-api.com/price/XPT | jq .price)
          PALLADIUM=$(curl -s https://api.gold-api.com/price/XPD | jq .price)
          COPPER=$(curl -s https://api.gold-api.com/price/HG | jq .price)

          # Read previous saved prices
          GOLD_OLD=$(jq -r ".\"$DATE\".gold // empty" $FILE)
          SILVER_OLD=$(jq -r ".\"$DATE\".silver // empty" $FILE)

          # ðŸ”” Gold alert (every 5 minutes)
          if [ "$GOLD_OLD" != "" ]; then
            DIFF=$(echo "$GOLD - $GOLD_OLD" | bc)
            if (( $(echo "$DIFF != 0" | bc -l) )); then
              curl -s -X POST https://api.telegram.org/bot$BOT_TOKEN/sendMessage \
                -d chat_id=$CHAT_ID \
                -d text="ðŸš¨ Gold (1g) Update\nPrevious: â‚¹$GOLD_OLD\nCurrent: â‚¹$GOLD"
            fi
          fi

          # ðŸ”” Silver alert (every 5 minutes)
          if [ "$SILVER_OLD" != "" ]; then
            DIFF=$(echo "$SILVER - $SILVER_OLD" | bc)
            if (( $(echo "$DIFF != 0" | bc -l) )); then
              curl -s -X POST https://api.telegram.org/bot$BOT_TOKEN/sendMessage \
                -d chat_id=$CHAT_ID \
                -d text="ðŸš¨ Silver (1g) Update\nPrevious: â‚¹$SILVER_OLD\nCurrent: â‚¹$SILVER"
            fi
          fi

          # ðŸ“© Daily summary at 9 AM IST (03 UTC)
          if [ "$HOUR" = "03" ]; then
            curl -s -X POST https://api.telegram.org/bot$BOT_TOKEN/sendMessage \
              -d chat_id=$CHAT_ID \
              -d text="ðŸ“Š Daily Metal Prices (1g)\n\nGold: â‚¹$GOLD\nSilver: â‚¹$SILVER\nPlatinum: â‚¹$PLATINUM\nPalladium: â‚¹$PALLADIUM\nCopper: â‚¹$COPPER"
          fi

          # ðŸ’¾ Daily save (runs safely every time, overwrites same date)
          jq ".\"$DATE\" = {
            \"gold\": $GOLD,
            \"silver\": $SILVER,
            \"platinum\": $PLATINUM,
            \"palladium\": $PALLADIUM,
            \"copper\": $COPPER
          }" $FILE > temp.json

          mv temp.json $FILE

      - name: Commit & push
        run: |
          git config user.name github-actions
          git config user.email actions@github.com
          git add data/daily_prices.json
          git diff --cached --quiet || git commit -m "Metal prices update"
          git push
