name: Metal Prices Automation

on:
  schedule:
    - cron: '*/10 * * * *'
    - cron: '30 18 * * *'
    - cron: '30 3 * * *'
    - cron: '30 3 * * 0'
    - cron: '30 3 1 * *'
  workflow_dispatch:

jobs:
  metals:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq & bc
        run: sudo apt-get update && sudo apt-get install jq bc -y

      - name: Fetch prices, alert & save
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          DATE=$(date -u +"%Y-%m-%d")
          HOUR=$(date -u +"%H")
          DAY=$(date -u +"%w")
          DAY_OF_MONTH=$(date -u +"%d")
          FILE=data/daily_prices.json
          ALERT_FILE=data/last_alert_prices.json
          [ -f "$ALERT_FILE" ] || echo '{}' > "$ALERT_FILE"
          GOLD_OLD=$(jq -r '.gold // 0' "$ALERT_FILE")
          SILVER_OLD=$(jq -r '.silver // 0' "$ALERT_FILE")

          OZ=31.1035
          DUTY=1.06
          GST=1.03
          SILENT_START=17   # 11 PM IST
          SILENT_END=0      # 6 AM IST

          INR=$(curl -s "https://api.frankfurter.app/latest?from=USD&to=INR" | jq .rates.INR)

          GOLD_USD=$(curl -s https://api.gold-api.com/price/XAU | jq .price)
          SILVER_USD=$(curl -s https://api.gold-api.com/price/XAG | jq .price)
          PLATINUM_USD=$(curl -s https://api.gold-api.com/price/XPT | jq .price)
          PALLADIUM_USD=$(curl -s https://api.gold-api.com/price/XPD | jq .price)
          COPPER_USD=$(curl -s https://api.gold-api.com/price/HG | jq .price)

          GOLD=$(echo "scale=2; ($GOLD_USD/$OZ)*$INR*$DUTY*$GST" | bc)
          SILVER=$(echo "scale=2; ($SILVER_USD/$OZ)*$INR*$DUTY*$GST" | bc)
          GOLD_8G=$(echo "scale=2; $GOLD * 8" | bc)
          GOLD_OLD_8G=$(echo "scale=2; $GOLD_OLD * 8" | bc)
          SILVER_1KG=$(echo "scale=2; $SILVER * 1000" | bc)
          SILVER_OLD_1KG=$(echo "scale=2; $SILVER_OLD * 1000" | bc)
          PLATINUM=$(echo "scale=2; ($PLATINUM_USD/$OZ)*$INR*$DUTY*$GST" | bc)
          PALLADIUM=$(echo "scale=2; ($PALLADIUM_USD/$OZ)*$INR*$DUTY*$GST" | bc)
          COPPER=$(echo "scale=2; ($COPPER_USD/$OZ)*$INR*$DUTY*$GST" | bc)

          
          if [ "$GOLD_OLD" != "" ]; then
            DIFF=$(echo "$GOLD - $GOLD_OLD" | bc)
          
            if (( $(echo "$DIFF > 0" | bc -l) )); then
              ARROW="ðŸ”º"
            elif (( $(echo "$DIFF < 0" | bc -l) )); then
              ARROW="ðŸ”»"
            else
              ARROW="âž–"
            fi
          
            if ! { [ "$HOUR" -ge "$SILENT_START" ] || [ "$HOUR" -lt 6 ]; }; then
              MESSAGE="$ARROW Gold Price Alert"
              MESSAGE="$MESSAGE"$'\n'"1g: â‚¹$GOLD (Prev â‚¹$GOLD_OLD)"
              MESSAGE="$MESSAGE"$'\n'"8g: â‚¹$GOLD_8G (Prev â‚¹$GOLD_OLD_8G)"
          
              curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
                -d chat_id="$CHAT_ID" \
                --data-urlencode text="$MESSAGE"
            fi
          fi

          if [ "$SILVER_OLD" != "" ]; then
            DIFF=$(echo "$SILVER - $SILVER_OLD" | bc)
            
            if (( $(echo "$DIFF > 0" | bc -l) )); then
              ARROW="ðŸ”º"
            elif (( $(echo "$DIFF < 0" | bc -l) )); then
              ARROW="ðŸ”»"
            else
              ARROW="âž–"
            fi
            if ! { [ "$HOUR" -ge "$SILENT_START" ] || [ "$HOUR" -lt 6 ]; }; then
              MESSAGE="$ARROW Silver Price Alert"
              MESSAGE="$MESSAGE"$'\n'"1g: â‚¹$SILVER (Prev â‚¹$SILVER_OLD)"
              MESSAGE="$MESSAGE"$'\n'"1kg: â‚¹$SILVER_1KG (Prev â‚¹$SILVER_OLD_1KG)"
              curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
                -d chat_id="$CHAT_ID" \
                --data-urlencode text="$MESSAGE"
            fi
          fi

          jq ".gold = $GOLD | .silver = $SILVER" "$ALERT_FILE" > temp_alert.json
          mv temp_alert.json "$ALERT_FILE"

          if [ "$HOUR" = "03" ]; then
            YESTERDAY=$(date -u -d "yesterday" +"%Y-%m-%d")

            GOLD_Y=$(jq -r ".\"$YESTERDAY\".gold // 0" "$FILE")
            SILVER_Y=$(jq -r ".\"$YESTERDAY\".silver // 0" "$FILE")
            PLATINUM_Y=$(jq -r ".\"$YESTERDAY\".platinum // 0" "$FILE")
            PALLADIUM_Y=$(jq -r ".\"$YESTERDAY\".palladium // 0" "$FILE")
            COPPER_Y=$(jq -r ".\"$YESTERDAY\".copper // 0" "$FILE")
            
            goldArrow=$([ "$(echo "$GOLD > $GOLD_Y" | bc)" -eq 1 ] && echo "ðŸ”º" || echo "ðŸ”»")
            silverArrow=$([ "$(echo "$SILVER > $SILVER_Y" | bc)" -eq 1 ] && echo "ðŸ”º" || echo "ðŸ”»")
            platinumArrow=$([ "$(echo "$PLATINUM > $PLATINUM_Y" | bc)" -eq 1 ] && echo "ðŸ”º" || echo "ðŸ”»")
            palladiumArrow=$([ "$(echo "$PALLADIUM > $PALLADIUM_Y" | bc)" -eq 1 ] && echo "ðŸ”º" || echo "ðŸ”»")
            copperArrow=$([ "$(echo "$COPPER > $COPPER_Y" | bc)" -eq 1 ] && echo "ðŸ”º" || echo "ðŸ”»")
            MESSAGE="ðŸ“Š Daily Metal Prices (1g)"

            MESSAGE="$MESSAGE"$'\n\n'"$goldArrow Gold: â‚¹$GOLD (Î” â‚¹$(echo "$GOLD - $GOLD_Y" | bc))"
            MESSAGE="$MESSAGE"$'\n'"$silverArrow Silver: â‚¹$SILVER (Î” â‚¹$(echo "$SILVER - $SILVER_Y" | bc))"
            MESSAGE="$MESSAGE"$'\n'"$platinumArrow Platinum: â‚¹$PLATINUM (Î” â‚¹$(echo "$PLATINUM - $PLATINUM_Y" | bc))"
            MESSAGE="$MESSAGE"$'\n'"$palladiumArrow Palladium: â‚¹$PALLADIUM (Î” â‚¹$(echo "$PALLADIUM - $PALLADIUM_Y" | bc))"
            MESSAGE="$MESSAGE"$'\n'"$copperArrow Copper: â‚¹$COPPER (Î” â‚¹$(echo "$COPPER - $COPPER_Y" | bc))"
            curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
              -d chat_id="$CHAT_ID" \
              --data-urlencode text="$MESSAGE"
          fi

          if [ "$DAY" = "0" ] && [ "$HOUR" = "03" ]; then
            END_DATE=$(date -u +"%Y-%m-%d")
            START_DATE=$(date -u -d "7 days ago" +"%Y-%m-%d")

            GOLD_START=$(jq -r ".\"$START_DATE\".gold // empty" "$FILE")
            GOLD_END=$(jq -r ".\"$END_DATE\".gold // empty" "$FILE")
            SILVER_START=$(jq -r ".\"$START_DATE\".silver // empty" "$FILE")
            SILVER_END=$(jq -r ".\"$END_DATE\".silver // empty" "$FILE")

            GOLD_DIFF=$(echo "$GOLD_END - $GOLD_START" | bc)
            SILVER_DIFF=$(echo "$SILVER_END - $SILVER_START" | bc)

            GOLD_PCT=$(echo "scale=2; ($GOLD_DIFF / $GOLD_START) * 100" | bc)
            SILVER_PCT=$(echo "scale=2; ($SILVER_DIFF / $SILVER_START) * 100" | bc)

            MESSAGE="ðŸ“ˆ Weekly Summary (1g)"
            MESSAGE="$MESSAGE"$'\n'"From: $(date -d "$START_DATE" +%d/%m/%Y) â†’ $(date -d "$END_DATE" +%d/%m/%Y)"
            MESSAGE="$MESSAGE"$'\n\n'"Gold: â‚¹$GOLD_DIFF ($GOLD_PCT%)"
            MESSAGE="$MESSAGE"$'\n'"Silver: â‚¹$SILVER_DIFF ($SILVER_PCT%)"

            curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
              -d chat_id="$CHAT_ID" \
              --data-urlencode text="$MESSAGE"
          fi

          if [ "$DAY_OF_MONTH" = "01" ] && [ "$HOUR" = "03" ]; then
            END_DATE=$(date -u -d "yesterday" +"%Y-%m-%d")
            START_DATE=$(date -u -d "$(date -u +%Y-%m-01)" +"%Y-%m-%d")

            GOLD_START=$(jq -r ".\"$START_DATE\".gold // empty" "$FILE")
            GOLD_END=$(jq -r ".\"$END_DATE\".gold // empty" "$FILE")
            SILVER_START=$(jq -r ".\"$START_DATE\".silver // empty" "$FILE")
            SILVER_END=$(jq -r ".\"$END_DATE\".silver // empty" "$FILE")

            GOLD_DIFF=$(echo "$GOLD_END - $GOLD_START" | bc)
            SILVER_DIFF=$(echo "$SILVER_END - $SILVER_START" | bc)

            GOLD_PCT=$(echo "scale=2; ($GOLD_DIFF / $GOLD_START) * 100" | bc)
            SILVER_PCT=$(echo "scale=2; ($SILVER_DIFF / $SILVER_START) * 100" | bc)

            MESSAGE="ðŸ“… Monthly Summary (1g)"
            MESSAGE="$MESSAGE"$'\n'"From: $(date -d "$START_DATE" +%d/%m/%Y) â†’ $(date -d "$END_DATE" +%d/%m/%Y)"
            MESSAGE="$MESSAGE"$'\n\n'"Gold: â‚¹$GOLD_DIFF ($GOLD_PCT%)"
            MESSAGE="$MESSAGE"$'\n'"Silver: â‚¹$SILVER_DIFF ($SILVER_PCT%)"

            curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
              -d chat_id="$CHAT_ID" \
              --data-urlencode text="$MESSAGE"
          fi

          jq ".\"$DATE\" = {
            \"gold\": $GOLD,
            \"silver\": $SILVER,
            \"platinum\": $PLATINUM,
            \"palladium\": $PALLADIUM,
            \"copper\": $COPPER
          }" "$FILE" > temp.json

          mv temp.json "$FILE"

      - name: Commit & push
        run: |
          git config user.name github-actions
          git config user.email actions@github.com
          git add data/daily_prices.json data/last_alert_prices.json
          git diff --cached --quiet || git commit -m "Metal prices update"
          git push
