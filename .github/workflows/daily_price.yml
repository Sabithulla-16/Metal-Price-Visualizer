name: Metal Prices Automation

on:
  schedule:
    - cron: '*/5 * * * *'
    - cron: '30 18 * * *'
    - cron: '30 3 * * *'
    - cron: '30 3 * * 0'
    - cron: '30 3 1 * *'
  workflow_dispatch:

concurrency:
  group: metal-prices
  cancel-in-progress: false

jobs:
  metals:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq & bc
        run: sudo apt-get update && sudo apt-get install jq bc -y

      - name: Fetch prices, alert & save
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "CRON DEBUG â†’ triggered at UTC $(date -u)"
          set -x
          DATE=$(date -u +"%Y-%m-%d")
          HOUR=$(date -u +"%H")
          MIN=$(date -u +"%M")
          if (( MIN % 10 != 0 )); then
            echo "Skipping non-10-min slot"
            exit 0
          fi
          DAY=$(date -u +"%w")
          DAY_OF_MONTH=$(date -u +"%d")
          echo "DEBUG â†’ UTC hour: $HOUR"
          FILE=data/daily_prices.json
          ALERT_FILE=data/last_alert_prices.json
          [ -f "$ALERT_FILE" ] || echo '{}' > "$ALERT_FILE"
          GOLD_OLD=$(jq -r '.gold // 0' "$ALERT_FILE")
          SILVER_OLD=$(jq -r '.silver // 0' "$ALERT_FILE")

          OZ=31.1035
          DUTY=1.06
          GST=1.03
          SILENT_START=18   # 11 PM IST

          format_inr() {
            printf "%'.2f" "$1"
          }

          INR=$(curl -s "https://api.frankfurter.app/latest?from=USD&to=INR" | jq .rates.INR)

          GOLD_USD=$(curl -s https://api.gold-api.com/price/XAU | jq .price)
          SILVER_USD=$(curl -s https://api.gold-api.com/price/XAG | jq .price)
          PLATINUM_USD=$(curl -s https://api.gold-api.com/price/XPT | jq .price)
          PALLADIUM_USD=$(curl -s https://api.gold-api.com/price/XPD | jq .price)
          COPPER_USD=$(curl -s https://api.gold-api.com/price/HG | jq .price)

          GOLD=$(echo "scale=2; ($GOLD_USD/$OZ)*$INR*$DUTY*$GST" | bc)
          SILVER=$(echo "scale=2; ($SILVER_USD/$OZ)*$INR*$DUTY*$GST" | bc)
          GOLD_8G=$(echo "scale=2; $GOLD * 8" | bc)
          GOLD_OLD_8G=$(echo "scale=2; $GOLD_OLD * 8" | bc)
          SILVER_1KG=$(echo "scale=2; $SILVER * 1000" | bc)
          SILVER_OLD_1KG=$(echo "scale=2; $SILVER_OLD * 1000" | bc)
          PLATINUM=$(echo "scale=2; ($PLATINUM_USD/$OZ)*$INR*$DUTY*$GST" | bc)
          PALLADIUM=$(echo "scale=2; ($PALLADIUM_USD/$OZ)*$INR*$DUTY*$GST" | bc)
          COPPER=$(echo "scale=2; ($COPPER_USD/$OZ)*$INR*$DUTY*$GST" | bc)

          
          # --- Combined 10-minute Alert (Gold + Silver) ---

          DIFF_GOLD=$(echo "$GOLD - $GOLD_OLD" | bc)
          DIFF_SILVER=$(echo "$SILVER - $SILVER_OLD" | bc)
          
          # Arrows
          if (( $(echo "$DIFF_GOLD > 0" | bc -l) )); then
            GOLD_ARROW="ðŸ”´ðŸ“ˆ"
          elif (( $(echo "$DIFF_GOLD < 0" | bc -l) )); then
            GOLD_ARROW="ðŸŸ¢ðŸ“‰"
          else
            GOLD_ARROW="âšªâž–"
          fi
          
          if (( $(echo "$DIFF_SILVER > 0" | bc -l) )); then
            SILVER_ARROW="ðŸ”´ðŸ“ˆ"
          elif (( $(echo "$DIFF_SILVER < 0" | bc -l) )); then
            SILVER_ARROW="ðŸŸ¢ðŸ“‰"
          else
            SILVER_ARROW="âšªâž–"
          fi
          
          # Derived prices
          GOLD_8G=$(echo "scale=2; $GOLD * 8" | bc)
          GOLD_OLD_8G=$(echo "scale=2; $GOLD_OLD * 8" | bc)
          
          SILVER_1KG=$(echo "scale=2; $SILVER * 1000" | bc)
          SILVER_OLD_1KG=$(echo "scale=2; $SILVER_OLD * 1000" | bc)
          
          # Silent window: 11 PM â€“ 6 AM IST (UTC-based)
          if ! { [ "$HOUR" -ge "$SILENT_START" ] && [ "$HOUR" -le 23 ] || [ "$HOUR" -eq 0 ]; }; then
          
            MESSAGE="ðŸ”” Metal Price Update (10 mins)"
          
            MESSAGE="$MESSAGE"$'\n\n'"ðŸ¥‡ Gold"
            MESSAGE="$MESSAGE"$'\n'"$GOLD_ARROW 1g: â‚¹$(format_inr "$GOLD")  (Î” â‚¹$(format_inr "$DIFF_GOLD"))"
            MESSAGE="$MESSAGE"$'\n'"$GOLD_ARROW 8g: â‚¹$(format_inr "$GOLD_8G")  (Î” â‚¹$(format_inr "$(echo "$DIFF_GOLD * 8" | bc)"))"
          
            MESSAGE="$MESSAGE"$'\n\n'"ðŸ¥ˆ Silver"
            MESSAGE="$MESSAGE"$'\n'"$SILVER_ARROW 1g: â‚¹$(format_inr "$SILVER")  (Î” â‚¹$(format_inr "$DIFF_SILVER"))"
            MESSAGE="$MESSAGE"$'\n'"$SILVER_ARROW 1kg: â‚¹$(format_inr "$SILVER_1KG")  (Î” â‚¹$(format_inr "$(echo "$DIFF_SILVER * 1000" | bc)"))"
          
            curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
              -d chat_id="$CHAT_ID" \
              --data-urlencode text="$MESSAGE"
          fi

          jq ".gold = $GOLD | .silver = $SILVER" "$ALERT_FILE" > temp_alert.json
          mv temp_alert.json "$ALERT_FILE"

          if [ "$HOUR" = "03" ]; then
            YESTERDAY=$(date -u -d "yesterday" +"%Y-%m-%d")

            GOLD_Y=$(jq -r ".\"$YESTERDAY\".gold // 0" "$FILE")
            SILVER_Y=$(jq -r ".\"$YESTERDAY\".silver // 0" "$FILE")
            PLATINUM_Y=$(jq -r ".\"$YESTERDAY\".platinum // 0" "$FILE")
            PALLADIUM_Y=$(jq -r ".\"$YESTERDAY\".palladium // 0" "$FILE")
            COPPER_Y=$(jq -r ".\"$YESTERDAY\".copper // 0" "$FILE")
            
            goldArrow=$(
              if (( $(echo "$GOLD > $GOLD_Y" | bc -l) )); then echo "ðŸ”´ðŸ“ˆ"
              elif (( $(echo "$GOLD < $GOLD_Y" | bc -l) )); then echo "ðŸŸ¢ðŸ“‰"
              else echo "âšªâž–"; fi
            )
            
            silverArrow=$(
              if (( $(echo "$SILVER > $SILVER_Y" | bc -l) )); then echo "ðŸ”´ðŸ“ˆ"
              elif (( $(echo "$SILVER < $SILVER_Y" | bc -l) )); then echo "ðŸŸ¢ðŸ“‰"
              else echo "âšªâž–"; fi
            )
            
            platinumArrow=$(
              if (( $(echo "$PLATINUM > $PLATINUM_Y" | bc -l) )); then echo "ðŸ”´ðŸ“ˆ"
              elif (( $(echo "$PLATINUM < $PLATINUM_Y" | bc -l) )); then echo "ðŸŸ¢ðŸ“‰"
              else echo "âšªâž–"; fi
            )
            
            palladiumArrow=$(
              if (( $(echo "$PALLADIUM > $PALLADIUM_Y" | bc -l) )); then echo "ðŸ”´ðŸ“ˆ"
              elif (( $(echo "$PALLADIUM < $PALLADIUM_Y" | bc -l) )); then echo "ðŸŸ¢ðŸ“‰"
              else echo "âšªâž–"; fi
            )
            
            copperArrow=$(
              if (( $(echo "$COPPER > $COPPER_Y" | bc -l) )); then echo "ðŸ”´ðŸ“ˆ"
              elif (( $(echo "$COPPER < $COPPER_Y" | bc -l) )); then echo "ðŸŸ¢ðŸ“‰"
              else echo "âšªâž–"; fi
            )
            MESSAGE="ðŸ“Š Daily Metal Prices"

            MESSAGE="$MESSAGE"$'\n\n'"ðŸ¥‡ Gold"
            MESSAGE="$MESSAGE"$'\n'"$goldArrow 1g: â‚¹$(format_inr "$GOLD")  (Î” â‚¹$(format_inr "$(echo "$GOLD - $GOLD_Y" | bc)"))"
            MESSAGE="$MESSAGE"$'\n'"$goldArrow 8g: â‚¹$(format_inr "$(echo "$GOLD * 8" | bc)")"
            
            MESSAGE="$MESSAGE"$'\n\n'"ðŸ¥ˆ Silver"
            MESSAGE="$MESSAGE"$'\n'"$silverArrow 1g: â‚¹$(format_inr "$SILVER")  (Î” â‚¹$(format_inr "$(echo "$SILVER - $SILVER_Y" | bc)"))"
            MESSAGE="$MESSAGE"$'\n'"$silverArrow 1kg: â‚¹$(format_inr "$(echo "$SILVER * 1000" | bc)")"
            
            MESSAGE="$MESSAGE"$'\n\n'"ðŸ”© Platinum: â‚¹$(format_inr "$PLATINUM")"
            MESSAGE="$MESSAGE"$'\n'"âš™ï¸ Palladium: â‚¹$(format_inr "$PALLADIUM")"
            MESSAGE="$MESSAGE"$'\n'"ðŸ§² Copper: â‚¹$(format_inr "$COPPER")"
            curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
              -d chat_id="$CHAT_ID" \
              --data-urlencode text="$MESSAGE"
          fi

          if [ "$DAY" = "0" ] && [ "$HOUR" = "03" ]; then
            END_DATE=$(date -u +"%Y-%m-%d")
            START_DATE=$(date -u -d "7 days ago" +"%Y-%m-%d")

            GOLD_START=$(jq -r ".\"$START_DATE\".gold // empty" "$FILE")
            GOLD_END=$(jq -r ".\"$END_DATE\".gold // empty" "$FILE")
            SILVER_START=$(jq -r ".\"$START_DATE\".silver // empty" "$FILE")
            SILVER_END=$(jq -r ".\"$END_DATE\".silver // empty" "$FILE")

            GOLD_DIFF=$(echo "$GOLD_END - $GOLD_START" | bc)
            SILVER_DIFF=$(echo "$SILVER_END - $SILVER_START" | bc)

            GOLD_PCT=$(echo "scale=2; ($GOLD_DIFF / $GOLD_START) * 100" | bc)
            SILVER_PCT=$(echo "scale=2; ($SILVER_DIFF / $SILVER_START) * 100" | bc)

            MESSAGE="ðŸ“ˆ Weekly Metal Summary"
            MESSAGE="$MESSAGE"$'\n'"From: $(date -d "$START_DATE" +%d/%m/%Y) â†’ $(date -d "$END_DATE" +%d/%m/%Y)"
            
            MESSAGE="$MESSAGE"$'\n\n'"ðŸ¥‡ Gold"
            MESSAGE="$MESSAGE"$'\n'"Î” â‚¹$(format_inr "$GOLD_DIFF")  ($GOLD_PCT%)"
            
            MESSAGE="$MESSAGE"$'\n\n'"ðŸ¥ˆ Silver"
            MESSAGE="$MESSAGE"$'\n'"Î” â‚¹$(format_inr "$SILVER_DIFF")  ($SILVER_PCT%)"

            curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
              -d chat_id="$CHAT_ID" \
              --data-urlencode text="$MESSAGE"
          fi

          if [ "$DAY_OF_MONTH" = "01" ] && [ "$HOUR" = "03" ]; then
            END_DATE=$(date -u -d "yesterday" +"%Y-%m-%d")
            START_DATE=$(date -u -d "$(date -u +%Y-%m-01)" +"%Y-%m-%d")

            GOLD_START=$(jq -r ".\"$START_DATE\".gold // empty" "$FILE")
            GOLD_END=$(jq -r ".\"$END_DATE\".gold // empty" "$FILE")
            SILVER_START=$(jq -r ".\"$START_DATE\".silver // empty" "$FILE")
            SILVER_END=$(jq -r ".\"$END_DATE\".silver // empty" "$FILE")

            GOLD_DIFF=$(echo "$GOLD_END - $GOLD_START" | bc)
            SILVER_DIFF=$(echo "$SILVER_END - $SILVER_START" | bc)

            GOLD_PCT=$(echo "scale=2; ($GOLD_DIFF / $GOLD_START) * 100" | bc)
            SILVER_PCT=$(echo "scale=2; ($SILVER_DIFF / $SILVER_START) * 100" | bc)

            MESSAGE="ðŸ“… Monthly Metal Summary"
            MESSAGE="$MESSAGE"$'\n'"From: $(date -d "$START_DATE" +%d/%m/%Y) â†’ $(date -d "$END_DATE" +%d/%m/%Y)"
            
            MESSAGE="$MESSAGE"$'\n\n'"ðŸ¥‡ Gold"
            MESSAGE="$MESSAGE"$'\n'"Î” â‚¹$(format_inr "$GOLD_DIFF")  ($GOLD_PCT%)"
            
            MESSAGE="$MESSAGE"$'\n\n'"ðŸ¥ˆ Silver"
            MESSAGE="$MESSAGE"$'\n'"Î” â‚¹$(format_inr "$SILVER_DIFF")  ($SILVER_PCT%)"

            curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
              -d chat_id="$CHAT_ID" \
              --data-urlencode text="$MESSAGE"
          fi

          jq ".\"$DATE\" = {
            \"gold\": $GOLD,
            \"silver\": $SILVER,
            \"platinum\": $PLATINUM,
            \"palladium\": $PALLADIUM,
            \"copper\": $COPPER
          }" "$FILE" > temp.json

          mv temp.json "$FILE"

      - name: Commit & push
        run: |
          git config user.name github-actions
          git config user.email actions@github.com
          git add data/daily_prices.json data/last_alert_prices.json
          git diff --cached --quiet || git commit -m "Metal prices update"
          git push
